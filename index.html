<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Metadonnées -->
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="Arsène Brosy & Maltered" name="author">
    <meta content="Création, site, internet, web, design" name="keywords">
    <meta content="Creez vos sites web avec des pros a mini-prix" name="description">

    <!-- Titre -->
    <title>Devcastle - Création de site webs a mini-prix</title>

    <!-- CSS -->
    <link href="../css/fonts/fonts.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <script src="https://js.stripe.com/v3"></script>
</head>
<body>
<div class="Paiement">
    <div id="choixPaiement">
        <h2>Moyen de paiement</h2>
        <p>Séléctionnez un moyen de paiement</p>
        <div class="moyenPaiement">
            <div class="paypal" id="paypal">
                <div class="alignCard">
                    <img height="54" src="src/Icons/PaypalIcon.png" width="54"/>
                    <p>Paypal</p>
                </div>
            </div>
            <div class="bankCard" id="bankCard">
                <div class="alignCard">
                    <img height="32.31" src="src/Icons/MastercardIcon.png" width="52.14"/>
                    <p>Carte bancaire</p>
                </div>
            </div>
        </div>
        <input id="continueButton" type="submit" value="12321">
        <input id="button" type="submit" value="checkout">
    </div>

    <script>

        var stripe = Stripe(
            "pk_test_51MnPY1AsyBISG9sIg93Bj2eFdhGwPElL1L2tSgcWDQscnM69Ri2Dt5a8pI6nzfHX7eS0jiGJjsmj0z48a7eH5SzZ00YzXQoWHJ"
        )

        button.addEventListener('click', (e) => {
            stripe.redirectToCheckout({
                lineItems: [
                    {
                        price: "price_1MxushAsyBISG9sIlOEIBlXd",
                        quantity: 1,
                    },
                ],
                mode: "subscription",
                successUrl: "https://google.com/",
                cancelUrl: "https://twitter.com/",
            })
                .then(function (result) {
                });
        })

        var moyenPaiementSelect = "";

        paypal.addEventListener('click', (e) => {
            document.getElementById('paypal').style.backgroundColor = '#9AC7FF';
            document.getElementById('paypal').style.borderColor = '#57A2FF';
            moyenPaiementSelect = "paypal";
            document.getElementById('bankCard').style.backgroundColor = 'white';
            document.getElementById('bankCard').style.borderColor = '#cccccc';
        });

        bankCard.addEventListener('click', (e) => {
            document.getElementById('bankCard').style.backgroundColor = '#9AC7FF';
            document.getElementById('bankCard').style.borderColor = '#57A2FF';
            moyenPaiementSelect = "card";
            document.getElementById('paypal').style.backgroundColor = 'white';
            document.getElementById('paypal').style.borderColor = '#cccccc';
        });

        continueButton.addEventListener('click', (e) => {
            if (moyenPaiementSelect == "") {
                alert("alert")
            } else {
                document.getElementById('choixPaiement').style.display = 'none';
                document.getElementById('cartePaiement').style.display = 'block';
            }
        });

    </script>

    <div class="cartePaiement" id="cartePaiement">
        <h2>Paiement</h2>

        <div class="retour" id="retour">
            <img src="src/Icons/retourIcon.png"/>
            <p>Retour</p>
        </div>

        <script>
            retour.addEventListener('click', (e) => {
                document.getElementById('choixPaiement').style.display = 'block';
                document.getElementById('cartePaiement').style.display = 'none';
            });
        </script>

        <div class="infoPers">
            <div class="nom">
                <p>Nom</p>
                <input type="text">
            </div>
            <div class="prenom">
                <p>Prénom</p>
                <input type="text">
            </div>
        </div>
        <div>
            <p>Numéro de carte</p>
            <input class="numCarte" id="number" maxlength="19" onkeypress="isInputNumber(event)" placeholder="1234 1234 1234 1234"
                   type="text">
        </div>
        <div class="expirationCVV">
            <div class="expiration">
                <p>Expiration</p>
                <input id="date" maxlength="5" onkeypress="isInputNumber(event)" placeholder=" MM/AA" type="text">
            </div>
            <div class="CVV">
                <p>CVV</p>
                <input id="cvv" maxlength="3" onkeypress="isInputNumber(event)" placeholder=" 123" type="text">
            </div>
        </div>
        <script>
            function isInputNumber(evt) {
                var ch = String.fromCharCode(evt.which);
                if (!(/[0-9]/.test(ch))) {
                    evt.preventDefault();
                }
            };
        </script>
        <button class="inscriptionButton " id="payerButton"><span>PAYER</span></button>
    </div>

    <div class="achatList">
        <h2>Votre commande</h2>
        <hr>
        <div class="paiementSiteWeb">
            <p>Site web</p>
            <p><span class="chf">CHF </span><span class="prix" id="sitePrix">---</span></p>
        </div>
        <div class="paiementHebergeur">
            <p>Hebergement</p>
            <p><span class="trace-chf">CHF 60</span><span class="chf">CHF </span><span class="prix"
                                                                                       id="hebergPrix">---</span></p>
        </div>
        <hr>
        <div class="remiseSuisse" id="suisseRemise">
            <p>Remise de 5% pour les suisses</p>
            <p><span class="chf">CHF </span><span class="prix" id="suisseRemisePrix">---</span></p>
        </div>
        <div class="remisePremiere" id="firstCommande">
            <p>Bonus de première commande</p>
            <p><span>CHF </span><span class="prix">-10</span></p>
        </div>
        <hr id="remiseSeparation">
        <div class="total">
            <p>Total</p>
            <p>CHF <span id="total">---</span></p>
        </div>
        <p class="arrondiText">Arrondi favorable pour vous</p>
    </div>
</div>

<script type="module">

    import {initializeApp} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import {getAuth} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
    import {
        getDatabase,
        set,
        ref,
        onValue,
        update
    } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDpxXNFrji99t8a6QTcKhCmgIdA0ibs_lk",
        authDomain: "webcastle-website.firebaseapp.com",
        databaseURL: "https://webcastle-website-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "webcastle-website",
        storageBucket: "webcastle-website.appspot.com",
        messagingSenderId: "274339465548",
        appId: "1:274339465548:web:927dd550601c84dffce7e9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);

    let cNumber = document.getElementById('number');
    cNumber.addEventListener('keyup', function (e) {

        let num = cNumber.value;

        let newValue = '';
        num = num.replace(/\s/g, '');
        for (var i = 0; i < num.length; i++) {
            if (i % 4 == 0 && i > 0) newValue = newValue.concat(' ');
            newValue = newValue.concat(num[i]);
            cNumber.value = newValue;
        }
    });

    let date = document.getElementById('date');
    date.addEventListener('keyup', function (e) {

        if (e.which !== 8) {
            var numChars = e.target.value.length;
            if (numChars == 2) {
                var thisVal = e.target.value;
                thisVal += '/';
                e.target.value = thisVal;
                console.log(thisVal.length)
            }
        }
    });

    var prixTotal = 0;

    var sitePrix = 505.99;
    var hebergPrix = 50;

    var suisseRemisePrix = 0;
    var firstCommandePrix = 0;

    var firstCommande = true;
    var suisseRemise = true;

    window.addEventListener('load', function () {

        const user = auth.currentUser;

        var pays = "";
        onValue(ref(database, '/users/' + user.uid ), (snapshot) => {
            pays = (snapshot.val().pays);
        });

        alert(pays);

        if (firstCommande == false) {
            document.getElementById('firstCommande').style.display = 'none';
        } else {
            firstCommandePrix = 10;
        }

        if (firstCommande == false && suisseRemise == false) {
            document.getElementById('remiseSeparation').style.display = 'none';
        }
        ;

        document.getElementById('sitePrix').innerHTML = sitePrix;
        document.getElementById('hebergPrix').innerHTML = hebergPrix;

        prixTotal = sitePrix + hebergPrix - suisseRemisePrix - firstCommandePrix;
        document.getElementById('total').innerHTML = prixTotal;
    });

    payerButton.addEventListener('click', (e) => {

        document.getElementById('payerButton').disabled = true;
        document.getElementById('payerButton').classList.toggle('inscriptionButton-loading')

        const user = auth.currentUser;

        var numFacture = 0;

        var now = new Date();
        var date = now.getDate() + "." + (now.getMonth() + 1) + "." + now.getFullYear();

        onValue(ref(database, '/users/' + user.uid + "/facturation"), (snapshot) => {
            numFacture = (snapshot.val().nombre_facture);
        });

        set(ref(database, 'users/' + user.uid + "/facturation/facture_" + (numFacture + 1)), {
            prix: prixTotal,
            date: date
        });

        update(ref(database, 'users/' + user.uid + "/facturation"), {
            nombre_facture: numFacture + 1
        });
    });

</script>

<footer>
    <div class="center">
        <p>En effectuant votre commande, vous acceptez nos <a href="">Termes d’utilisation</a></p>
        <p class="paiementSecureFooter">Paiements sécurisés avec <strong>Stripe</strong></p>
    </div>
</footer>

</body>
</html>